<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMK - MU - Laporan Keuangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="Logo.png">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #transaction-list::-webkit-scrollbar { width: 8px; }
        #transaction-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #transaction-list::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #transaction-list::-webkit-scrollbar-thumb:hover { background: #555; }
        .filter-btn.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-900">

    <!-- Kontainer untuk Halaman Login/Registrasi (Awalnya terlihat) -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <!-- Tampilan Login -->
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center">Login KeuanganKu</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <input type="email" id="login-email" placeholder="Alamat Email" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg" required>
                    <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Login</button>
                </form>
                <p class="mt-4 text-sm text-center" style="display:none">Belum punya akun? <a href="#" id="show-register" class="font-medium text-blue-600 hover:underline">Daftar di sini</a></p>
            </div>
            <!-- Tampilan Registrasi (Awalnya tersembunyi) -->
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center">Daftar Akun Baru</h2>
                <form id="register-form" class="mt-8 space-y-6">
                    <input type="email" id="register-email" placeholder="Alamat Email" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="password" id="register-password" placeholder="Password (minimal 6 karakter)" class="w-full px-4 py-2 border rounded-lg" required>
                    <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Daftar</button>
                </form>
                <p class="mt-4 text-sm text-center">Sudah punya akun? <a href="#" id="show-login" class="font-medium text-blue-600 hover:underline">Login di sini</a></p>
            </div>
            <p id="auth-error" class="text-red-500 text-sm text-center mt-2"></p>
        </div>
    </div>

    <!-- Kontainer untuk Aplikasi Utama (Awalnya tersembunyi) -->
    <div id="app-container" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-2">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl sm:text-2xl font-bold text-blue-600">SMK M-U</h1>
                    <div id="digital-clock" class="hidden sm:block text-lg font-semibold text-gray-700 bg-gray-100 px-3 py-1 rounded-lg shadow-inner"></div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <span id="user-email" class="hidden sm:block text-sm text-gray-600"></span>
                    <!--<button id="migrate-btn" class="bg-yellow-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg hover:bg-yellow-600 transition-colors text-xs sm:text-sm">-->
                    <!--    Pindahkan Data Lama-->
                    <!--</button>-->
                    <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg hover:bg-red-600 transition-colors text-xs sm:text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <main id="main-content" class="container mx-auto p-4 md:p-8">
            <!-- Dashboard dirender di sini -->
        </main>
    </div>
    
    <!-- Template Dashboard -->
    <template id="dashboard-view">
        <div id="summary-section"></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Tambah Transaksi Baru</h2>
                <form id="transaction-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1 md:col-span-2">
                            <div class="flex justify-center gap-4">
                                <label class="flex-1 p-3 rounded-lg text-center cursor-pointer transition-all bg-gray-200 text-gray-700 has-[:checked]:bg-green-500 has-[:checked]:text-white has-[:checked]:shadow-md">
                                    <input type="radio" name="type" value="Pemasukan" class="hidden" /> Pemasukan
                                </label>
                                <label class="flex-1 p-3 rounded-lg text-center cursor-pointer transition-all bg-red-500 text-white shadow-md has-[:checked]:bg-red-500 has-[:checked]:text-white has-[:checked]:shadow-md">
                                    <input type="radio" name="type" value="Pengeluaran" class="hidden" checked /> Pengeluaran
                                </label>
                            </div>
                        </div>
                        <input type="text" id="description" placeholder="Deskripsi (e.g., Makan siang)" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2" required />
                        <input type="number" id="amount" placeholder="Jumlah (e.g., 50000)" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required />
                        <select id="category" class="p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500" required></select>
                        <input type="date" id="date" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2" required />
                    </div>
                    <button type="submit" id="submit-btn" class="w-full mt-4 bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">Tambahkan</button>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Riwayat Transaksi</h2>
                    <div class="flex items-center gap-2 self-start sm:self-center">
                         <button id="import-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm">Import</button>
                         <input type="file" id="import-file-input" class="hidden" accept=".json">
                         <button id="export-excel-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">Export</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="relative flex-grow">
                        <input type="text" id="search-input" placeholder="Cari transaksi..." class="w-full p-2 pl-4 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="filter-buttons" class="flex-shrink-0 flex items-center justify-center gap-2">
                        <button data-filter="semua" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 active">Semua</button>
                        <button data-filter="pemasukan" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">Pemasukan</button>
                        <button data-filter="pengeluaran" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">Pengeluaran</button>
                    </div>
                </div>
                <div id="transaction-list" class="space-y-3 min-h-[22rem] pr-2"></div>
                <div id="pagination-controls" class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t gap-2"></div>
            </div>
        </div>
    </template>
    
    <!-- Modal untuk Edit Transaksi -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-6">Edit Transaksi</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1 md:col-span-2">
                        <div id="edit-type-container" class="flex justify-center gap-4">
                            <!-- Opsi radio akan di-render oleh JS -->
                        </div>
                    </div>
                    <input type="text" id="edit-description" placeholder="Deskripsi" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2" required />
                    <input type="number" id="edit-amount" placeholder="Jumlah" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required />
                    <select id="edit-category" class="p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500" required></select>
                    <input type="date" id="edit-date" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2" required />
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
    </div>

    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfQ-fkqZIWFhpR4scQvAbaPCykUGpdzGA",
            authDomain: "keuangansmk-dfdcf.firebaseapp.com",
            projectId: "keuangansmk-dfdcf",
            storageBucket: "keuangansmk-dfdcf.appspot.com",
            messagingSenderId: "63210771692",
            appId: "1:63210771692:web:956a3b9b9b727be08cc1c9",
            measurementId: "G-V8K682E130"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- VARIABEL GLOBAL ---
        const CATEGORIES = ['Dana Awal', 'SPP', 'Gaji', 'Makanan & Minuman', 'Transportasi', 'Belanja', 'Tagihan', 'Kesehatan', 'Hiburan', 'Pendidikan', 'Investasi', 'Lainnya'];
        
        let allTransactions = [];
        let currentFilter = 'semua';
        let searchTerm = '';
        let currentPage = 1;
        let ITEMS_PER_PAGE = 10;
        let currentUser = null;
        let transactionsCollection = null;

        // --- ELEMEN DOM (diambil sekali untuk efisiensi) ---
        let mainContent, loadingOverlay, authContainer, appContainer;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Assign elemen DOM setelah dokumen siap
            mainContent = document.getElementById('main-content');
            loadingOverlay = document.getElementById('loading-overlay');
            authContainer = document.getElementById('auth-container');
            appContainer = document.getElementById('app-container');

            // Setup listener untuk halaman login/register
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); registerView.classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); registerView.classList.add('hidden'); loginView.classList.remove('hidden'); });
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('migrate-btn').addEventListener('click', handleMigrateData);
            document.getElementById('clear-data-btn').addEventListener('click', clearAllData);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', handleFileImport);
        });

        // --- MANAJEMEN AUTENTIKASI ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                transactionsCollection = db.collection('users').doc(currentUser.uid).collection('transactions');
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.email;
                updateView();
                updateClock();
                setInterval(updateClock, 1000);
            } else {
                currentUser = null;
                transactionsCollection = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('auth-error');
            errorP.textContent = '';
            showLoading();
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                errorP.textContent = "Email atau password salah.";
            } finally {
                hideLoading();
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorP = document.getElementById('auth-error');
            errorP.textContent = '';
            showLoading();
            try {
                await auth.createUserWithEmailAndPassword(email, password);
            } catch (error) {
                if (error.code == 'auth/weak-password') {
                    errorP.textContent = 'Password terlalu lemah, minimal 6 karakter.';
                } else if (error.code == 'auth/email-already-in-use') {
                    errorP.textContent = 'Email sudah terdaftar.';
                } else {
                    errorP.textContent = 'Gagal mendaftar, coba lagi.';
                }
            } finally {
                hideLoading();
            }
        }

        async function handleLogout() {
            await auth.signOut();
        }

        // --- FUNGSI MIGRASI DATA ---
        async function handleMigrateData() {
            if (!confirm("Anda akan mencoba memindahkan data dari struktur lama ke akun Anda. Lakukan ini hanya sekali. Lanjutkan?")) return;
            showLoading();
            try {
                const oldTransactionsRef = db.collection('transactions');
                const snapshot = await oldTransactionsRef.get();
                if (snapshot.empty) {
                    alert("Tidak ada data lama yang ditemukan untuk dipindahkan.");
                    return;
                }
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const newDocRef = transactionsCollection.doc(doc.id);
                    batch.set(newDocRef, data);
                });
                await batch.commit();
                alert(`Berhasil memindahkan ${snapshot.size} data lama. Silakan refresh halaman.`);
                await updateView();
            } catch (error) {
                handleError(error, "Gagal memindahkan data. Pastikan Aturan Keamanan (Security Rules) sudah diubah sementara sesuai panduan.");
            } finally {
                hideLoading();
            }
        }

        // --- FUNGSI INTERAKSI DENGAN FIREBASE ---
        async function fetchTransactions() {
            if (!transactionsCollection) return;
            showLoading();
            try {
                const snapshot = await transactionsCollection.orderBy("date", "desc").orderBy("createdAt", "desc").get();
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                if (error.code === 'failed-precondition') {
                    console.error("Firestore index missing:", error.message);
                    alert("Gagal mengurutkan data. Anda perlu membuat 'index' di Firebase. Cek 'console' browser (F12) untuk link pembuatan otomatis.");
                } else {
                    handleError(error, 'Gagal mengambil data dari Firebase.');
                }
                allTransactions = [];
            } finally {
                hideLoading();
            }
        }

        async function addTransaction(transaction) {
            if (!transactionsCollection) return;
            showLoading();
            try {
                transaction.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await transactionsCollection.add(transaction);
                await updateView();
            } catch (error) {
                handleError(error, 'Gagal menambahkan transaksi.');
            } finally {
                hideLoading();
            }
        }
        
        async function updateTransaction(id, transactionData) {
            if (!transactionsCollection) return;
            showLoading();
            try {
                await transactionsCollection.doc(id).update(transactionData);
                closeEditModal();
                await updateView();
            } catch (error) {
                handleError(error, 'Gagal menyimpan perubahan.');
            } finally {
                hideLoading();
            }
        }

        async function deleteTransaction(id) {
            if (!transactionsCollection) return;
            if (confirm("Anda yakin ingin menghapus transaksi ini?")) {
                showLoading();
                try {
                    await transactionsCollection.doc(id).delete();
                    await updateView();
                } catch (error) {
                    handleError(error, 'Gagal menghapus transaksi di database.');
                } finally {
                    hideLoading();
                }
            }
        }

        async function clearAllData() {
            if (!transactionsCollection) return;
            if (confirm("PERINGATAN: Anda akan menghapus SEMUA data transaksi secara permanen. Lanjutkan?")) {
                showLoading();
                try {
                    const snapshot = await transactionsCollection.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    await updateView();
                } catch (error) {
                    handleError(error, 'Gagal menghapus semua data.');
                } finally {
                    hideLoading();
                }
            }
        }

        // --- RENDER DAN FUNGSI LAINNYA ---
        async function updateView() {
            await fetchTransactions();
            renderDashboard();
        }

        function renderDashboard() {
            const template = document.getElementById('dashboard-view');
            mainContent.innerHTML = '';
            mainContent.appendChild(template.content.cloneNode(true));
            
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('transaction-list').addEventListener('click', handleListClick);
            document.getElementById('edit-form').addEventListener('submit', handleEditFormSubmit);
            document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);
            
            renderSummary(allTransactions);
            applyFiltersAndRender();
            setupAddForm();
            setupFilterControls();
        }

        function applyFiltersAndRender() {
            const filteredTransactions = getFilteredTransactions();
            const totalPages = Math.ceil(filteredTransactions.length / ITEMS_PER_PAGE);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedItems = filteredTransactions.slice(startIndex, endIndex);
            renderTransactionList(paginatedItems);
            renderPaginationControls(filteredTransactions.length);
        }

        function renderTransactionList(transactions) {
            const listContainer = document.getElementById('transaction-list');
            let transactionsHTML = transactions.length > 0 ? transactions.map(t => `<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50 border group"><div class="flex items-center gap-3 overflow-hidden"><div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center ${t.type === 'Pemasukan' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}"><span class="text-xl font-bold">${t.type === 'Pemasukan' ? '↓' : '↑'}</span></div><div class="overflow-hidden"><p class="font-semibold text-gray-800 truncate">${t.description}</p><p class="text-sm text-gray-500">${t.category} • ${new Date(t.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long' })}</p></div></div><div class="flex items-center gap-2 flex-shrink-0"><p class="font-bold text-base sm:text-lg ${t.type === 'Pemasukan' ? 'text-green-600' : 'text-red-600'}">${t.type === 'Pemasukan' ? '+' : '-'}Rp ${parseFloat(t.amount || 0).toLocaleString('id-ID')}</p><div class="flex opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity"><button class="edit-btn p-1 text-gray-500 hover:text-blue-600" title="Edit" data-id="${t.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="delete-btn p-1 text-gray-500 hover:text-red-600" title="Hapus" data-id="${t.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></div></div>`).join('') : '<p class="text-center text-gray-500 py-8">Tidak ada transaksi yang cocok.</p>';
            if (transactions.length > 0) {
                const currentPageTotal = transactions.reduce((sum, t) => { const amount = parseFloat(t.amount || 0); return t.type === 'Pemasukan' ? sum + amount : sum - amount; }, 0);
                const totalColor = currentPageTotal >= 0 ? 'text-green-600' : 'text-red-600';
                const totalPrefix = currentPageTotal >= 0 ? '+' : '-';
                const totalRowHTML = `<div class="flex justify-between items-center p-3 rounded-lg bg-gray-100 border-t-2 border-gray-300 mt-2 font-bold"><p class="text-gray-800">Total Halaman Ini</p><p class="text-lg ${totalColor}">${totalPrefix}Rp ${Math.abs(currentPageTotal).toLocaleString('id-ID')}</p></div>`;
                transactionsHTML += totalRowHTML;
            }
            listContainer.innerHTML = transactionsHTML;
        }

        function renderPaginationControls(totalItems) { const controlsContainer = document.getElementById('pagination-controls'); const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE); if (totalPages <= 1 && totalItems <= ITEMS_PER_PAGE) { controlsContainer.innerHTML = ''; return; } const prevDisabled = currentPage === 1 ? 'disabled' : ''; const nextDisabled = currentPage === totalPages ? 'disabled' : ''; const itemsPerPageOptions = [5, 10, 25, 50]; const selectHTML = `<div class="flex items-center gap-2 text-sm"><label for="items-per-page" class="text-gray-600">Tampilkan:</label><select id="items-per-page" class="border rounded-md p-1 bg-white">${itemsPerPageOptions.map(option => `<option value="${option}" ${option === ITEMS_PER_PAGE ? 'selected' : ''}>${option}</option>`).join('')}</select></div>`; controlsContainer.innerHTML = `<div class="flex items-center gap-2"><button id="prev-page-btn" class="px-3 py-1 sm:px-4 sm:py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" ${prevDisabled}>Sebelumnya</button><button id="next-page-btn" class="px-3 py-1 sm:px-4 sm:py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" ${nextDisabled}>Berikutnya</button></div><span class="text-sm font-semibold text-gray-600 order-first sm:order-none w-full sm:w-auto text-center">Halaman ${currentPage} dari ${totalPages || 1}</span>${selectHTML}`; document.getElementById('prev-page-btn')?.addEventListener('click', () => { if (currentPage > 1) { currentPage--; applyFiltersAndRender(); } }); document.getElementById('next-page-btn')?.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; applyFiltersAndRender(); } }); document.getElementById('items-per-page').addEventListener('change', (e) => { ITEMS_PER_PAGE = parseInt(e.target.value, 10); currentPage = 1; applyFiltersAndRender(); }); }
        function handleListClick(event) { const editBtn = event.target.closest('.edit-btn'); if (editBtn) { const id = editBtn.dataset.id; const transaction = allTransactions.find(t => t.id === id); if (transaction) openEditModal(transaction); return; } const deleteBtn = event.target.closest('.delete-btn'); if (deleteBtn) { const id = deleteBtn.dataset.id; deleteTransaction(id); return; } }
        function setupAddForm() { const formContainer = document.getElementById('transaction-form'); const categorySelect = formContainer.querySelector('#category'); categorySelect.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join(''); categorySelect.value = 'Makanan & Minuman'; formContainer.querySelector('#date').value = new Date().toISOString().slice(0, 10); formContainer.addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; await addTransaction({ date: form.date.value, description: form.description.value, category: form.category.value, type: form.type.value, amount: parseFloat(form.amount.value) }); form.reset(); formContainer.querySelector('#date').value = new Date().toISOString().slice(0, 10); categorySelect.value = 'Makanan & Minuman'; }); }
        async function handleEditFormSubmit(e) { e.preventDefault(); const form = e.target; const id = form['edit-id'].value; const updatedData = { date: form['edit-date'].value, description: form['edit-description'].value, category: form['edit-category'].value, type: form.elements['edit-type'].value, amount: parseFloat(form['edit-amount'].value) }; await updateTransaction(id, updatedData); }
        function setupFilterControls() { const searchInput = document.getElementById('search-input'); const filterButtons = document.querySelectorAll('.filter-btn'); searchInput.value = searchTerm; searchInput.addEventListener('input', (e) => { currentPage = 1; searchTerm = e.target.value; applyFiltersAndRender(); }); filterButtons.forEach(btn => { if (btn.dataset.filter === currentFilter) { btn.classList.add('active'); } btn.addEventListener('click', (e) => { currentPage = 1; currentFilter = e.currentTarget.dataset.filter; filterButtons.forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active'); applyFiltersAndRender(); }); }); }
        function getFilteredTransactions() { let filtered = [...allTransactions]; if (currentFilter === 'pemasukan') { filtered = filtered.filter(t => t.type === 'Pemasukan'); } else if (currentFilter === 'pengeluaran') { filtered = filtered.filter(t => t.type === 'Pengeluaran'); } const term = searchTerm.toLowerCase(); if (term) { filtered = filtered.filter(t => t.description.toLowerCase().includes(term) || t.amount.toString().includes(term) || t.category.toLowerCase().includes(term) || t.date.includes(term)); } return filtered; }
        function renderSummary(transactions) { const { totalIncome, totalExpense } = transactions.reduce((acc, t) => { const amount = parseFloat(t.amount) || 0; if (t.type === 'Pemasukan') acc.totalIncome += amount; else acc.totalExpense += amount; return acc; }, { totalIncome: 0, totalExpense: 0 }); document.getElementById('summary-section').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow-md"><p class="text-sm font-semibold">Total Pemasukan</p> <p class="text-2xl font-bold">Rp ${totalIncome.toLocaleString('id-ID')}</p></div><div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow-md"><p class="text-sm font-semibold">Total Pengeluaran</p> <p class="text-2xl font-bold">Rp ${totalExpense.toLocaleString('id-ID')}</p></div><div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg shadow-md"><p class="text-sm font-semibold">Saldo Akhir</p> <p class="text-2xl font-bold">Rp ${(totalIncome - totalExpense).toLocaleString('id-ID')}</p></div></div>`; }
        function openEditModal(transaction) { const modal = document.getElementById('edit-modal'); const form = document.getElementById('edit-form'); form.querySelector('#edit-id').value = transaction.id; form.querySelector('#edit-description').value = transaction.description; form.querySelector('#edit-amount').value = transaction.amount; form.querySelector('#edit-date').value = transaction.date; const categorySelect = form.querySelector('#edit-category'); categorySelect.innerHTML = CATEGORIES.map(c => `<option value="${c}" ${c === transaction.category ? 'selected' : ''}>${c}</option>`).join(''); const typeContainer = form.querySelector('#edit-type-container'); typeContainer.innerHTML = `<label class="flex-1 p-3 rounded-lg text-center cursor-pointer transition-all ${transaction.type === 'Pemasukan' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}"><input type="radio" name="edit-type" value="Pemasukan" class="hidden" ${transaction.type === 'Pemasukan' ? 'checked' : ''} /> Pemasukan</label><label class="flex-1 p-3 rounded-lg text-center cursor-pointer transition-all ${transaction.type === 'Pengeluaran' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}"><input type="radio" name="edit-type" value="Pengeluaran" class="hidden" ${transaction.type === 'Pengeluaran' ? 'checked' : ''} /> Pengeluaran</label>`; modal.classList.remove('hidden'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
        function handleFileImport(event) { const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = async function(e) { try { const data = JSON.parse(e.target.result); if (data && Array.isArray(data.transactions)) { await importDataToFirebase(data.transactions); } else { throw new Error("Format file JSON tidak valid."); } } catch (error) { handleError(error, "Gagal membaca file JSON."); } }; reader.readAsText(file); event.target.value = null; }
        async function importDataToFirebase(transactions) { if (!confirm(`Anda akan mengimpor ${transactions.length} transaksi. Lanjutkan?`)) { return; } showLoading(); try { const batch = db.batch(); transactions.forEach(t => { const docRef = transactionsCollection.doc(); const transactionData = { ...t, createdAt: firebase.firestore.FieldValue.serverTimestamp() }; delete transactionData.id; batch.set(docRef, transactionData); }); await batch.commit(); alert(`Berhasil mengimpor ${transactions.length} transaksi!`); await updateView(); } catch (error) { handleError(error, "Gagal mengimpor data."); } finally { hideLoading(); } }
        function handleError(error, message) { console.error(message, error); alert(message); }
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function exportToExcel() { const dataToExport = getFilteredTransactions(); if (dataToExport.length === 0) { alert("Tidak ada data untuk diekspor."); return; } const headers = ["ID", "Tanggal", "Deskripsi", "Kategori", "Jenis", "Jumlah"]; const formattedData = dataToExport.map(t => [t.id, t.date, t.description, t.category, t.type, t.amount]); const worksheetData = [headers, ...formattedData]; const ws = XLSX.utils.aoa_to_sheet(worksheetData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Laporan Keuangan"); XLSX.writeFile(wb, "Laporan_KeuanganKu.xlsx"); }
        function updateClock() { const clockElement = document.getElementById('digital-clock'); if (clockElement) { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); const seconds = String(now.getSeconds()).padStart(2, '0'); clockElement.textContent = `${hours}:${minutes}:${seconds}`; } }
    </script>
</body>
</html>
