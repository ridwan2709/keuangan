<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMK M-U - Laporan Keuangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="LOGO.png">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #transaction-list::-webkit-scrollbar { width: 8px; }
        #transaction-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #transaction-list::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #transaction-list::-webkit-scrollbar-thumb:hover { background: #555; }
        .filter-btn.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-900">

    <!-- Kontainer untuk Halaman Login/Registrasi (Awalnya terlihat) -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <!-- Tampilan Login -->
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center">Login KeuanganKu</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <input type="email" id="login-email" placeholder="Alamat Email" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg" required>
                    <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Login</button>
                </form>
                <p class="mt-4 text-sm text-center" style="display:none">Belum punya akun? <a href="#" id="show-register" class="font-medium text-blue-600 hover:underline">Daftar di sini</a></p>
            </div>
            <!-- Tampilan Registrasi (Awalnya tersembunyi) -->
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center">Daftar Akun Baru</h2>
                <form id="register-form" class="mt-8 space-y-6">
                    <input type="email" id="register-email" placeholder="Alamat Email" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="password" id="register-password" placeholder="Password (minimal 6 karakter)" class="w-full px-4 py-2 border rounded-lg" required>
                    <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Daftar</button>
                </form>
                <p class="mt-4 text-sm text-center">Sudah punya akun? <a href="#" id="show-login" class="font-medium text-blue-600 hover:underline">Login di sini</a></p>
            </div>
            <p id="auth-error" class="text-red-500 text-sm text-center mt-2"></p>
        </div>
    </div>

    <!-- Kontainer untuk Aplikasi Utama (Awalnya tersembunyi) -->
    <div id="app-container" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-2">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl sm:text-2xl font-bold text-blue-600">SMK M-U</h1>
                    <div id="digital-clock" class="hidden sm:block text-lg font-semibold text-gray-700 bg-gray-100 px-3 py-1 rounded-lg shadow-inner"></div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <span id="user-email" class="hidden sm:block text-sm text-gray-600"></span>
                    <button id="migrate-btn" class="bg-yellow-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg hover:bg-yellow-600 transition-colors text-xs sm:text-sm">
                       Pindahkan Data Lama
                    </button>
                    <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg hover:bg-red-600 transition-colors text-xs sm:text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <main id="main-content" class="container mx-auto p-4 md:p-8">
            <!-- Dashboard dirender di sini -->
        </main>
    </div>
    
    <!-- Template Dashboard -->
    <template id="dashboard-view">
        <div id="summary-section"></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Tambah Transaksi Baru</h2>
                <form id="transaction-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1 md:col-span-2">
                            <div class="flex justify-center gap-4">
                                <label class="flex-1 p-3 rounded-lg text-center cursor-pointer transition-all bg-gray-200 text-gray-700 has-[:checked]:bg-green-500 has-[:checked]:text-white has-[:checked]:shadow-md">
                                    <input type="radio" name="type" value="Pemasukan" class="hidden" /> Pemasukan
                                </label>
                                <label class="flex-1 p-3 rounded-lg text-center cursor-pointer transition-all bg-red-500 text-white shadow-md has-[:checked]:bg-red-500 has-[:checked]:text-white has-[:checked]:shadow-md">
                                    <input type="radio" name="type" value="Pengeluaran" class="hidden" checked /> Pengeluaran
                                </label>
                            </div>
                        </div>
                        <input type="text" id="description" placeholder="Deskripsi (e.g., Makan siang)" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2" required />
                        <input type="number" id="amount" placeholder="Jumlah (e.g., 50000)" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required />
                        <select id="class" class="p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Kelas</option>
                            <option value="X">X</option>
                            <option value="XI">XI</option>
                            <option value="XII">XII</option>
                            <option value="Guru">Guru</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <div class="relative w-full">
                            <select id="category" class="w-full p-2 border rounded-lg" required>
                                <option value="">Pilih Kategori</option>
                            </select>
                        </div>
                        <div id="new-category-container" class="hidden mt-2">
                            <div class="flex gap-2">
                                <input type="text" id="new-category" placeholder="Nama kategori baru" class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <button type="button" id="save-category-btn" class="bg-green-500 text-white px-4 rounded-lg hover:bg-green-600 transition-colors">
                                    <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M4 12.4434L8.14339 16.5868C8.81006 17.2535 9.14339 17.5868 9.5576 17.5868C9.97182 17.5868 10.3051 17.2535 10.9718 16.5868L20.001 7.55762"
                                        stroke="black" stroke-width="1.6" stroke-linecap="round" class="my-path"></path>
                                    </svg>
                                </button>
                                <button type="button" id="cancel-category-btn" class="bg-gray-300 text-gray-700 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                    <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7.75732 7.75745L16.2426 16.2427" stroke="black" stroke-width="1.6"
                                        stroke-linecap="round" class="my-path"></path>
                                    <path d="M16.2426 7.75745L7.75732 16.2427" stroke="black" stroke-width="1.6"
                                        stroke-linecap="round" class="my-path"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <input type="date" id="date" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required />
                    </div>
                    <button type="submit" id="submit-btn" class="w-full mt-4 bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">Tambahkan</button>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Riwayat Transaksi</h2>
                    <div class="flex items-center gap-2 self-start sm:self-center">
                         <button id="import-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm">Import</button>
                         <input type="file" id="import-file-input" class="hidden" accept=".json">
                         <button id="export-excel-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">Export</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="relative flex-grow">
                        <input type="text" id="search-input" placeholder="Cari transaksi..." class="w-full p-2 pl-4 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="filter-buttons" class="flex-shrink-0 flex items-center justify-center gap-2">
                        <button data-filter="semua" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 active">Semua</button>
                        <button data-filter="pemasukan" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">Pemasukan</button>
                        <button data-filter="pengeluaran" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">Pengeluaran</button>
                    </div>
                </div>
                <div id="transaction-list" class="space-y-3 min-h-[22rem] pr-2"></div>
                <div id="pagination-controls" class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t gap-2"></div>
            </div>
        </div>
    </template>
    
    <!-- Modal untuk Edit Transaksi -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-6">Edit Transaksi</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1 md:col-span-2">
                        <div id="edit-type-container" class="flex justify-center gap-4">
                            <!-- Opsi radio akan di-render oleh JS -->
                        </div>
                    </div>
                    <input type="text" id="edit-description" placeholder="Deskripsi" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2" required />
                    <input type="number" id="edit-amount" placeholder="Jumlah" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required />
                    <select id="edit-category" class="p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500" required></select>
                    <select id="edit-class" class="p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Kelas</option>
                        <option value="X">X</option>
                        <option value="XI">XI</option>
                        <option value="XII">XII</option>
                        <option value="Guru">Guru</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                    <input type="date" id="edit-date" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2" required />
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
    </div>

    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfQ-fkqZIWFhpR4scQvAbaPCykUGpdzGA",
            authDomain: "keuangansmk-dfdcf.firebaseapp.com",
            projectId: "keuangansmk-dfdcf",
            storageBucket: "keuangansmk-dfdcf.appspot.com",
            messagingSenderId: "63210771692",
            appId: "1:63210771692:web:956a3b9b9b727be08cc1c9",
            measurementId: "G-V8K682E130"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- VARIABEL GLOBAL ---
        let CATEGORIES = ['Sumbangan', 'Dana Bos', 'Iuran Bulanan', 'Lainnya'];
        
        // Inisialisasi kategori dari localStorage jika ada
        if (localStorage.getItem('categories')) {
            try {
                const savedCategories = JSON.parse(localStorage.getItem('categories'));
                if (Array.isArray(savedCategories) && savedCategories.length > 0) {
                    CATEGORIES = [...new Set([...savedCategories, ...CATEGORIES])];
                }
            } catch (e) {
                console.error('Error loading categories from localStorage:', e);
            }
        }
        
        // Simpan kategori ke localStorage
        function saveCategoriesToLocalStorage() {
            try {
                localStorage.setItem('categories', JSON.stringify(CATEGORIES));
            } catch (e) {
                console.error('Error saving categories to localStorage:', e);
            }
        }
        const CLASSES = ['X', 'XI', 'XII', 'Guru', 'Lainnya'];
        
        let allTransactions = [];
        let currentFilter = 'semua';
        let searchTerm = '';
        let currentPage = 1;
        let ITEMS_PER_PAGE = 10;
        let currentUser = null;
        let transactionsCollection = null;

        // Inisialisasi elemen kategori
        function initCategoryElements() {
            categorySelect = document.getElementById('category');
            classSelect = document.getElementById('class');
            addCategoryBtn = document.getElementById('add-category-btn');
            newCategoryContainer = document.getElementById('new-category-container');
            saveCategoryBtn = document.getElementById('save-category-btn');
            cancelCategoryBtn = document.getElementById('cancel-category-btn');
            newCategoryInput = document.getElementById('new-category');
            
            // Setup event listeners untuk kategori
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', () => {
                    newCategoryContainer.classList.remove('hidden');
                    newCategoryInput.value = ''; // Clear previous input
                    newCategoryInput.focus();
                });
            }
            
            if (saveCategoryBtn) {
                saveCategoryBtn.addEventListener('click', addNewCategory);
            }
            
            if (cancelCategoryBtn) {
                cancelCategoryBtn.addEventListener('click', () => {
                    newCategoryInput.value = '';
                    newCategoryContainer.classList.add('hidden');
                });
            }
            
            if (newCategoryInput) {
                newCategoryInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addNewCategory();
                    }
                });
            }
        }
        
        // Fungsi untuk menambahkan kategori baru
        function addNewCategory() {
            const newCategory = newCategoryInput.value.trim();
            if (newCategory && !CATEGORIES.includes(newCategory)) {
                CATEGORIES.push(newCategory);
                saveCategoriesToLocalStorage();
                updateCategorySelect(newCategory);
                newCategoryInput.value = '';
                newCategoryContainer.classList.add('hidden');
                
                // Perbarui juga dropdown kategori di modal edit jika ada
                const editCategorySelect = document.getElementById('edit-category');
                if (editCategorySelect) {
                    const option = document.createElement('option');
                    option.value = newCategory;
                    option.textContent = newCategory;
                    editCategorySelect.appendChild(option);
                    editCategorySelect.value = newCategory;
                }
            }
        }
        
        // Fungsi untuk menghapus kategori
        function deleteCategory(category) {
            if (confirm(`Yakin ingin menghapus kategori "${category}"?`)) {
                const index = CATEGORIES.indexOf(category);
                if (index > -1) {
                    CATEGORIES.splice(index, 1);
                    saveCategoriesToLocalStorage();
                    updateCategorySelect();
                    
                    // Update juga dropdown kategori di modal edit jika ada
                    const editCategorySelect = document.getElementById('edit-category');
                    if (editCategorySelect) {
                        updateEditCategorySelect();
                    }
                    
                    alert(`Kategori "${category}" berhasil dihapus`);
                }
            }
        }
        
        // Fungsi untuk memperbarui dropdown kategori
        function updateCategorySelect(selectedCategory = null) {
            if (!categorySelect) return;
            
            const currentValue = selectedCategory || categorySelect.value;
            categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
            
            // Buat wrapper untuk custom select
            const selectWrapper = categorySelect.parentElement;
            const customSelect = document.createElement('div');
            customSelect.className = 'relative';
            
            // Buat tombol select yang bisa diklik
            const selectButton = document.createElement('button');
            selectButton.type = 'button';
            selectButton.className = 'w-full text-left px-4 py-2 bg-white border rounded-lg flex justify-between items-center';
            selectButton.innerHTML = `
                <span id="selected-category">${currentValue || 'Pilih Kategori'}</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            `;
            
            // Buat dropdown menu
            const dropdownMenu = document.createElement('div');
            dropdownMenu.className = 'hidden absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto';
            
            // Urutkan kategori secara alfabetis
            const sortedCategories = [...new Set(CATEGORIES)].sort();
            
            // Tambahkan tombol hapus untuk setiap kategori
            sortedCategories.forEach(category => {
                const option = document.createElement('div');
                option.className = 'flex items-center justify-between px-4 py-2 hover:bg-gray-100 cursor-pointer';
                option.innerHTML = `
                    <span>${category}</span>
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="event.stopPropagation(); deleteCategory('${category}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                `;
                option.addEventListener('click', () => {
                    categorySelect.value = category;
                    document.getElementById('selected-category').textContent = category;
                    dropdownMenu.classList.add('hidden');
                });
                dropdownMenu.appendChild(option);
            });
            
            // Tambahkan opsi untuk menambahkan kategori baru
            const addOption = document.createElement('div');
            addOption.className = 'px-4 py-2 text-blue-500 hover:bg-gray-100 cursor-pointer';
            addOption.innerHTML = '+ Tambah Kategori Baru';
            addOption.addEventListener('click', (e) => {
                e.stopPropagation();
                newCategoryContainer.classList.remove('hidden');
                newCategoryInput.value = '';
                newCategoryInput.focus();
                dropdownMenu.classList.add('hidden');
            });
            dropdownMenu.appendChild(addOption);
            
            // Tampilkan/sembunyikan dropdown saat tombol diklik
            selectButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !dropdownMenu.classList.contains('hidden');
                document.querySelectorAll('.custom-select-dropdown').forEach(dropdown => {
                    if (dropdown !== dropdownMenu) dropdown.classList.add('hidden');
                });
                dropdownMenu.classList.toggle('hidden', isOpen);
            });
            
            // Sembunyikan dropdown saat klik di luar
            document.addEventListener('click', (e) => {
                if (!selectWrapper.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
            
            // Hapus elemen custom select yang lama jika ada
            const oldCustomSelect = selectWrapper.querySelector('.custom-select');
            if (oldCustomSelect) {
                selectWrapper.removeChild(oldCustomSelect);
            }
            
            // Tambahkan class untuk custom select
            customSelect.className = 'custom-select w-full';
            customSelect.appendChild(selectButton);
            customSelect.appendChild(dropdownMenu);
            dropdownMenu.classList.add('custom-select-dropdown');
            
            // Ganti select asli dengan custom select
            categorySelect.style.display = 'none';
            selectWrapper.appendChild(customSelect);
            
            // Update nilai select saat berubah
            categorySelect.addEventListener('change', (e) => {
                document.getElementById('selected-category').textContent = e.target.value || 'Pilih Kategori';
            });
        }

        // --- ELEMEN DOM (diambil sekali untuk efisiensi) ---
        let mainContent, loadingOverlay, authContainer, appContainer, categorySelect, classSelect, addCategoryBtn, newCategoryContainer, saveCategoryBtn, cancelCategoryBtn, newCategoryInput;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Assign elemen DOM setelah dokumen siap
            mainContent = document.getElementById('main-content');
            loadingOverlay = document.getElementById('loading-overlay');
            authContainer = document.getElementById('auth-container');
            appContainer = document.getElementById('app-container');
            
            // Setup listener untuk halaman login/register
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); registerView.classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); registerView.classList.add('hidden'); loginView.classList.remove('hidden'); });
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            // document.getElementById('migrate-btn').addEventListener('click', handleMigrateData);
            // document.getElementById('clear-data-btn').addEventListener('click', clearAllData);
            // document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            // document.getElementById('import-file-input').addEventListener('change', handleFileImport);

            initCategoryElements();
        });

        // --- MANAJEMEN AUTENTIKASI ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                transactionsCollection = db.collection('users').doc(currentUser.uid).collection('transactions');
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.email;
                updateView();
                updateClock();
                setInterval(updateClock, 1000);
            } else {
                currentUser = null;
                transactionsCollection = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('auth-error');
            errorP.textContent = '';
            showLoading();
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                errorP.textContent = "Email atau password salah.";
            } finally {
                hideLoading();
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorP = document.getElementById('auth-error');
            errorP.textContent = '';
            showLoading();
            try {
                await auth.createUserWithEmailAndPassword(email, password);
            } catch (error) {
                if (error.code == 'auth/weak-password') {
                    errorP.textContent = 'Password terlalu lemah, minimal 6 karakter.';
                } else if (error.code == 'auth/email-already-in-use') {
                    errorP.textContent = 'Email sudah terdaftar.';
                } else {
                    errorP.textContent = 'Gagal mendaftar, coba lagi.';
                }
            } finally {
                hideLoading();
            }
        }

        async function handleLogout() {
            await auth.signOut();
        }

        // --- FUNGSI MIGRASI DATA ---
        async function handleMigrateData() {
            if (!confirm("Anda akan mencoba memindahkan data dari struktur lama ke akun Anda. Lakukan ini hanya sekali. Lanjutkan?")) return;
            showLoading();
            try {
                const oldTransactionsRef = db.collection('transactions');
                const snapshot = await oldTransactionsRef.get();
                if (snapshot.empty) {
                    alert("Tidak ada data lama yang ditemukan untuk dipindahkan.");
                    return;
                }
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const newDocRef = transactionsCollection.doc(doc.id);
                    batch.set(newDocRef, data);
                });
                await batch.commit();
                alert(`Berhasil memindahkan ${snapshot.size} data lama. Silakan refresh halaman.`);
                await updateView();
            } catch (error) {
                handleError(error, "Gagal memindahkan data. Pastikan Aturan Keamanan (Security Rules) sudah diubah sementara sesuai panduan.");
            } finally {
                hideLoading();
            }
        }

        // --- FUNGSI INTERAKSI DENGAN FIREBASE ---
        async function fetchTransactions() {
            if (!transactionsCollection) return;
            showLoading();
            try {
                const snapshot = await transactionsCollection.orderBy("date", "desc").orderBy("createdAt", "desc").get();
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                if (error.code === 'failed-precondition') {
                    console.error("Firestore index missing:", error.message);
                    alert("Gagal mengurutkan data. Anda perlu membuat 'index' di Firebase. Cek 'console' browser (F12) untuk link pembuatan otomatis.");
                } else {
                    handleError(error, 'Gagal mengambil data dari Firebase.');
                }
                allTransactions = [];
            } finally {
                hideLoading();
            }
        }

        async function addTransaction(transaction) {
            if (!transactionsCollection) return;
            showLoading();
            try {
                transaction.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await transactionsCollection.add(transaction);
                await updateView();
            } catch (error) {
                handleError(error, 'Gagal menambahkan transaksi.');
            } finally {
                hideLoading();
            }
        }
        
        async function updateTransaction(id, transactionData) {
            if (!transactionsCollection) return;
            showLoading();
            try {
                await transactionsCollection.doc(id).update(transactionData);
                closeEditModal();
                await updateView();
            } catch (error) {
                handleError(error, 'Gagal menyimpan perubahan.');
            } finally {
                hideLoading();
            }
        }

        async function deleteTransaction(id) {
            if (!transactionsCollection) return;
            if (confirm("Anda yakin ingin menghapus transaksi ini?")) {
                showLoading();
                try {
                    await transactionsCollection.doc(id).delete();
                    await updateView();
                } catch (error) {
                    handleError(error, 'Gagal menghapus transaksi di database.');
                } finally {
                    hideLoading();
                }
            }
        }

        async function clearAllData() {
            if (!transactionsCollection) return;
            if (confirm("PERINGATAN: Anda akan menghapus SEMUA data transaksi secara permanen. Lanjutkan?")) {
                showLoading();
                try {
                    const snapshot = await transactionsCollection.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    await updateView();
                } catch (error) {
                    handleError(error, 'Gagal menghapus semua data.');
                } finally {
                    hideLoading();
                }
            }
        }

        // --- RENDER DAN FUNGSI LAINNYA ---
        async function updateView() {
            await fetchTransactions();
            renderDashboard();
        }

        function renderDashboard() {
            const template = document.getElementById('dashboard-view');
            mainContent.innerHTML = '';
            mainContent.appendChild(template.content.cloneNode(true));
            
            // Initialize category elements and update dropdown
            initCategoryElements();
            updateCategorySelect();
            
            // Set up event listeners
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('transaction-list').addEventListener('click', handleListClick);
            document.getElementById('edit-form').addEventListener('submit', handleEditFormSubmit);
            document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);
            
            renderSummary(allTransactions);
            applyFiltersAndRender();
            setupAddForm();
            setupFilterControls();
        }

        function applyFiltersAndRender() {
            const filteredTransactions = getFilteredTransactions();
            const totalPages = Math.ceil(filteredTransactions.length / ITEMS_PER_PAGE);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedItems = filteredTransactions.slice(startIndex, endIndex);
            renderTransactionList(paginatedItems);
            renderPaginationControls(filteredTransactions.length);
        }

        function renderTransactionList(transactions) {
            const listContainer = document.getElementById('transaction-list');
            let transactionsHTML = transactions.length > 0 ? transactions.map(t => `<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50 border group"><div class="flex items-center gap-3 overflow-hidden"><div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center ${t.type === 'Pemasukan' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}"><span class="text-xl font-bold">${t.type === 'Pemasukan' ? '↓' : '↑'}</span></div><div class="overflow-hidden"><p class="font-semibold text-gray-800 truncate">${t.description}</p><p class="text-sm text-gray-500">${t.category} • ${new Date(t.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long' })}</p></div></div><div class="flex items-center gap-2 flex-shrink-0"><p class="font-bold text-base sm:text-lg ${t.type === 'Pemasukan' ? 'text-green-600' : 'text-red-600'}">${t.type === 'Pemasukan' ? '+' : '-'}Rp ${parseFloat(t.amount || 0).toLocaleString('id-ID')}</p><div class="flex opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity"><button class="edit-btn p-1 text-gray-500 hover:text-blue-600" title="Edit" data-id="${t.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="delete-btn p-1 text-gray-500 hover:text-red-600" title="Hapus" data-id="${t.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></div></div>`).join('') : '<p class="text-center text-gray-500 py-8">Tidak ada transaksi yang cocok.</p>';
            if (transactions.length > 0) {
                const currentPageTotal = transactions.reduce((sum, t) => { const amount = parseFloat(t.amount || 0); return t.type === 'Pemasukan' ? sum + amount : sum - amount; }, 0);
                const totalColor = currentPageTotal >= 0 ? 'text-green-600' : 'text-red-600';
                const totalPrefix = currentPageTotal >= 0 ? '+' : '-';
                const totalRowHTML = `<div class="flex justify-between items-center p-3 rounded-lg bg-gray-100 border-t-2 border-gray-300 mt-2 font-bold"><p class="text-gray-800">Total Halaman Ini</p><p class="text-lg ${totalColor}">${totalPrefix}Rp ${Math.abs(currentPageTotal).toLocaleString('id-ID')}</p></div>`;
                transactionsHTML += totalRowHTML;
            }
            listContainer.innerHTML = transactionsHTML;
        }

        function renderPaginationControls(totalItems) { const controlsContainer = document.getElementById('pagination-controls'); const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE); if (totalPages <= 1 && totalItems <= ITEMS_PER_PAGE) { controlsContainer.innerHTML = ''; return; } const prevDisabled = currentPage === 1 ? 'disabled' : ''; const nextDisabled = currentPage === totalPages ? 'disabled' : ''; const itemsPerPageOptions = [5, 10, 25, 50]; const selectHTML = `<div class="flex items-center gap-2 text-sm"><label for="items-per-page" class="text-gray-600">Tampilkan:</label><select id="items-per-page" class="border rounded-md p-1 bg-white">${itemsPerPageOptions.map(option => `<option value="${option}" ${option === ITEMS_PER_PAGE ? 'selected' : ''}>${option}</option>`).join('')}</select></div>`; controlsContainer.innerHTML = `<div class="flex items-center gap-2"><button id="prev-page-btn" class="px-3 py-1 sm:px-4 sm:py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" ${prevDisabled}>Sebelumnya</button><button id="next-page-btn" class="px-3 py-1 sm:px-4 sm:py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" ${nextDisabled}>Berikutnya</button></div><span class="text-sm font-semibold text-gray-600 order-first sm:order-none w-full sm:w-auto text-center">Halaman ${currentPage} dari ${totalPages || 1}</span>${selectHTML}`; document.getElementById('prev-page-btn')?.addEventListener('click', () => { if (currentPage > 1) { currentPage--; applyFiltersAndRender(); } }); document.getElementById('next-page-btn')?.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; applyFiltersAndRender(); } }); document.getElementById('items-per-page').addEventListener('change', (e) => { ITEMS_PER_PAGE = parseInt(e.target.value, 10); currentPage = 1; applyFiltersAndRender(); }); }
        function handleListClick(event) { const editBtn = event.target.closest('.edit-btn'); if (editBtn) { const id = editBtn.dataset.id; const transaction = allTransactions.find(t => t.id === id); if (transaction) openEditModal(transaction); return; } const deleteBtn = event.target.closest('.delete-btn'); if (deleteBtn) { const id = deleteBtn.dataset.id; deleteTransaction(id); return; } }
        function setupAddForm() { 
            const formContainer = document.getElementById('transaction-form'); 
            const categorySelect = formContainer.querySelector('#category'); 
            const classSelect = formContainer.querySelector('#class');
            
            // Set default values
            formContainer.querySelector('#date').value = new Date().toISOString().slice(0, 10);
            
            formContainer.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const form = e.target; 
                
                // Basic validation
                if (!form.class.value) {
                    alert('Silakan pilih kelas');
                    return;
                }
                
                if (!form.category.value) {
                    alert('Silakan pilih kategori');
                    return;
                }
                
                try {
                    await addTransaction({ 
                        date: form.date.value, 
                        description: form.description.value, 
                        category: form.category.value, 
                        class: form.class.value,
                        type: form.type.value, 
                        amount: parseFloat(form.amount.value) 
                    }); 
                    
                    // Reset form but keep the class and date
                    form.reset();
                    form.date.value = new Date().toISOString().slice(0, 10);
                    form.class.value = '';
                    updateCategorySelect();
                    
                } catch (error) {
                    console.error('Error adding transaction:', error);
                    alert('Terjadi kesalahan saat menambahkan transaksi');
                }
            }); 
        }
        async function handleEditFormSubmit(e) { e.preventDefault(); const form = e.target; const id = form['edit-id'].value; const updatedData = { date: form['edit-date'].value, description: form['edit-description'].value, category: form['edit-category'].value, type: form.elements['edit-type'].value, amount: parseFloat(form['edit-amount'].value) }; await updateTransaction(id, updatedData); }
        function setupFilterControls() { const searchInput = document.getElementById('search-input'); const filterButtons = document.querySelectorAll('.filter-btn'); searchInput.value = searchTerm; searchInput.addEventListener('input', (e) => { currentPage = 1; searchTerm = e.target.value; applyFiltersAndRender(); }); filterButtons.forEach(btn => { if (btn.dataset.filter === currentFilter) { btn.classList.add('active'); } btn.addEventListener('click', (e) => { currentPage = 1; currentFilter = e.currentTarget.dataset.filter; filterButtons.forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active'); applyFiltersAndRender(); }); }); }
        function getFilteredTransactions() { let filtered = [...allTransactions]; if (currentFilter === 'pemasukan') { filtered = filtered.filter(t => t.type === 'Pemasukan'); } else if (currentFilter === 'pengeluaran') { filtered = filtered.filter(t => t.type === 'Pengeluaran'); } const term = searchTerm.toLowerCase(); if (term) { filtered = filtered.filter(t => t.description.toLowerCase().includes(term) || t.amount.toString().includes(term) || t.category.toLowerCase().includes(term) || t.date.includes(term)); } return filtered; }
        function renderSummary(transactions) { const { totalIncome, totalExpense } = transactions.reduce((acc, t) => { const amount = parseFloat(t.amount) || 0; if (t.type === 'Pemasukan') acc.totalIncome += amount; else acc.totalExpense += amount; return acc; }, { totalIncome: 0, totalExpense: 0 }); document.getElementById('summary-section').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow-md"><p class="text-sm font-semibold">Total Pemasukan</p> <p class="text-2xl font-bold">Rp ${totalIncome.toLocaleString('id-ID')}</p></div><div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow-md"><p class="text-sm font-semibold">Total Pengeluaran</p> <p class="text-2xl font-bold">Rp ${totalExpense.toLocaleString('id-ID')}</p></div><div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg shadow-md"><p class="text-sm font-semibold">Saldo Akhir</p> <p class="text-2xl font-bold">Rp ${(totalIncome - totalExpense).toLocaleString('id-ID')}</p></div></div>`; }
        function openEditModal(transaction) { const modal = document.getElementById('edit-modal'); const form = document.getElementById('edit-form'); form.querySelector('#edit-id').value = transaction.id; form.querySelector('#edit-description').value = transaction.description || ''; form.querySelector('#edit-amount').value = transaction.amount || ''; const typeContainer = form.querySelector('#edit-type-container'); typeContainer.innerHTML = `<label class="flex-1 p-3 rounded-lg text-center cursor-pointer transition-all ${transaction.type === 'Pemasukan' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}"><input type="radio" name="edit-type" value="Pemasukan" class="hidden" ${transaction.type === 'Pemasukan' ? 'checked' : ''}> Pemasukan</label><label class="flex-1 p-3 rounded-lg text-center cursor-pointer transition-all ${transaction.type === 'Pengeluaran' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}"><input type="radio" name="edit-type" value="Pengeluaran" class="hidden" ${transaction.type === 'Pengeluaran' ? 'checked' : ''}> Pengeluaran</label>`; const categorySelect = form.querySelector('#edit-category'); categorySelect.innerHTML = CATEGORIES.map(cat => `<option value="${cat}" ${transaction.category === cat ? 'selected' : ''}>${cat}</option>`).join(''); const classSelect = form.querySelector('#edit-class'); classSelect.value = transaction.class || 'Lainnya'; form.querySelector('#edit-date').value = transaction.date || new Date().toISOString().split('T')[0]; modal.classList.remove('hidden'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
        function handleFileImport(event) { const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = async function(e) { try { const data = JSON.parse(e.target.result); if (data && Array.isArray(data.transactions)) { await importDataToFirebase(data.transactions); } else { throw new Error("Format file JSON tidak valid."); } } catch (error) { handleError(error, "Gagal membaca file JSON."); } }; reader.readAsText(file); event.target.value = null; }
        async function importDataToFirebase(transactions) { if (!confirm(`Anda akan mengimpor ${transactions.length} transaksi. Lanjutkan?`)) { return; } showLoading(); try { const batch = db.batch(); transactions.forEach(t => { const docRef = transactionsCollection.doc(); const transactionData = { ...t, createdAt: firebase.firestore.FieldValue.serverTimestamp() }; delete transactionData.id; batch.set(docRef, transactionData); }); await batch.commit(); alert(`Berhasil mengimpor ${transactions.length} transaksi!`); await updateView(); } catch (error) { handleError(error, "Gagal mengimpor data."); } finally { hideLoading(); } }
        function handleError(error, message) { console.error(message, error); alert(message); }
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function exportToExcel() { const dataToExport = getFilteredTransactions(); if (dataToExport.length === 0) { alert("Tidak ada data untuk diekspor."); return; } const headers = ["ID", "Tanggal", "Deskripsi", "Kategori", "Jenis", "Jumlah"]; const formattedData = dataToExport.map(t => [t.id, t.date, t.description, t.category, t.type, t.amount]); const worksheetData = [headers, ...formattedData]; const ws = XLSX.utils.aoa_to_sheet(worksheetData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Laporan Keuangan"); XLSX.writeFile(wb, "Laporan_KeuanganKu.xlsx"); }
        function updateClock() { const clockElement = document.getElementById('digital-clock'); if (clockElement) { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); const seconds = String(now.getSeconds()).padStart(2, '0'); clockElement.textContent = `${hours}:${minutes}:${seconds}`; } }
    </script>
</body>
</html>